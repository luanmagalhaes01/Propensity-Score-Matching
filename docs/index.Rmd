---
title: "Propensity Score Matching"
#institute: "Luan Magalhães"
#date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      widescreen: true  # Use true para 16:9
      ratio: 16:9
    slide_level: 2
    #css: ["white.css"]  # Adicione este arquivo CSS para a capa branca
---

<style>
body {
  font-family: "Manrope", sans-serif;
}
</style>

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```


```{r use-logo, echo=FALSE}
xaringanExtra::use_logo("logo.png")
```

## Introdução

Na ciência de dados, um dos grandes desafios é entender a **relação causal** entre variáveis. Quando não podemos realizar experimentos aleatórios por razões éticas, financeiras ou logísticas, os pesquisadores frequentemente usam **estudos observacionais**.

No entanto, esses estudos nem sempre garantem que os grupos comparados sejam equivalentes, o que pode gerar vieses e dificultar a interpretação dos resultados.

Para superar esse desafio, usamos técnicas de inferência causal, que ajudam a identificar o impacto real de uma variável (tratamento) em meio a possíveis influências externas.

Neste projeto, aplicaremos uma técnica chamada *Propensity Score Matching*, que busca equilibrar as características dos grupos de tratamento e controle, tornando-os mais semelhantes e, assim, facilitando a comparação.

---

## Contexto do Problema

Neste trabalho, analisaremos o efeito de frequentar uma escola católica, em comparação com escolas não católicas, no desempenho dos alunos.

Como os estudantes de escolas católicas geralmente têm perfis diferentes dos de escolas não católicas, utilizaremos o pareamento por escore de propensão para obter estimativas causais mais confiáveis.

--

- **A pergunta que surge é**: a diferença no desempenho é causada pelas escolas ou pelas trajetórias de vida dos alunos, que os colocam em situações de desigualdade?

--

- Em outras palavras, a escola é a responsável pela desigualdade ou é a história de vida dos alunos que gera essa disparidade?

---

## Propensity Score Matching

*Propensity Score Matching* (PSM) é uma técnica estatística usada reduzir o viés de seleção em estudos observacionais, onde os grupos de tratamento e controle não são formados de maneira aleatória.

O PSM usa um modelo probabilístico (geralmente uma **regressão logística**) para estimar a **probabilidade de um indivíduo receber o tratamento** com base em várias covariáveis.

Esse escore de propensão é, então, utilizado para parear indivíduos do grupo de tratamento com indivíduos do grupo de controle que possuem escores semelhantes, formando pares de observações comparáveis.

O resultado é uma estimativa do efeito causal que é mais confiável e precisa do que uma simples comparação de médias entre os grupos.

Embora o PSM dependa de variáveis observáveis e possa reduzir o tamanho da amostra, é uma ferramenta eficaz para aumentar a validade interna dos estudos.

---

## Variáveis utilizadas

**catholic**: Se a escola é católica (1) ou não (0);    

**c5r2mtsc_std**: Notas padronizadas de matemática;   

**p5hmage**: Idade da mãe;

**race_white**: Se aluno é da raça branca (1) ou não (0);

**w3income_1k**: Renda familiar (em milhares);   

**p5numpla**: Número de lugares onde o aluno viveu por pelo menos 4 meses;   

**w3momed_hsb**: O nível de educação da mãe é ensino médio ou menos (1) ou algum nível universitário ou superior (0)?

---

## Lendo dados

```{r echo=TRUE, message=FALSE, warning=FALSE}

library(kableExtra)  # Formatação de tabelas
library(MatchIt)     # Matching de dados em análises de causalidade
library(tidyverse)   # manipulação de dados
library(readr)       # usado para ler arquivos CSV

# Lê o arquivo CSV e armazena no dataframe 'ecls'
ecls <- read_csv("ecls.csv")  

# Seleciona colunas específicas do dataframe 'ecls'
ecls <- ecls %>%
  select('catholic', 'c5r2mtsc_std', 'p5hmage',
         'race_white','w3income_1k', 'p5numpla', 'w3momed_hsb')

ecls %>% head(2) %>% kable() # Exibe as duas primeiras linhas 

```

---

## Análise descritiva

### Média de matemática

• As notas nos testes de **c5r2mtsc_std** (média padronizada de matemática, utilizando a padronização z) diferem, em média, entre alunos de escolas católicas e não católicas?

```{r echo=TRUE, message=FALSE, warning=FALSE}

ecls %>%
  group_by(catholic) %>%
  summarise(n_students = n(),
            mean_math = mean(c5r2mtsc_std),
            std_error = sd(c5r2mtsc_std) / sqrt(n_students)) %>%
  kable()

```

---

## Análise descritiva

### Média de matemática

- A **média** das notas padronizadas de matemática é **maior** para alunos de **escolas católicas** (0.2197) do que para alunos de escolas não católicas (0.1631).

- A diferença de médias (0.2197 - 0.1631 = 0.0566) sugere que, em média, alunos de escolas católicas apresentam um desempenho levemente superior em matemática; no entanto, a significância dessa diferença ainda precisa ser verificada.

---

## Análise descritiva

### Média das variáveis

```{r echo=TRUE, message=FALSE, warning=FALSE}

ecls_cov <-c('race_white','p5hmage','w3income_1k','p5numpla','w3momed_hsb')

ecls %>%
  group_by(catholic) %>%
  select(one_of(ecls_cov)) %>% 
  summarise_all(funs(mean(.,na.rm = T))) %>% kable()

```

- *race_white*: **A proporção de alunos brancos é maior em escolas católicas** (76.67%) do que em não católicas (65.37%). Isso sugere uma maior concentração de alunos brancos em escolas católicas, o que pode estar relacionado com fatores históricos, sociais ou econômicos.  

---

## Análise descritiva

### Média das variáveis

- *Idade da mãe*: As mães de alunos em escolas católicas são um pouco mais velhas (39.78 anos) do que em escolas não católicas (37.79 anos), o que pode refletir diferenças socioeconômicas.

- *Renda familiar*: A renda é significativamente maior em escolas católicas (86.180) do que em escolas não católicas (65.393), influenciando o desempenho escolar.

- *Número de lugares vividos*: Alunos de escolas não católicas viveram em mais lugares (1.11) do que os de escolas católicas (1.07), indicando uma possível maior estabilidade em escolas católicas.

- *Escolaridade da mãe*: Mais mães em escolas católicas têm escolaridade superior ao ensino médio (79.46%) em comparação com escolas não católicas (60.77%).

---

## Análise descritiva

### Média das variáveis

- Essas variáveis apontam para um perfil mais privilegiado dos alunos de escolas católicas em comparação com os de escolas não católicas.

- Alunos de escolas católicas, em geral, têm maior probabilidade de serem brancos, terem mães mais velhas e com maior escolaridade, além de virem de famílias com rendas mais altas.

- Esses fatores podem contribuir para o desempenho acadêmico superior observado nos testes de matemática, embora seja necessário um estudo mais aprofundado para confirmar essas relações e evitar conclusões simplistas.

---

## Teste t

O teste t é uma ferramenta estatística usada para comparar a média de dois grupos e verificar se as diferenças observadas entre as médias são significativas ou podem ter ocorrido por acaso.

O que o teste t faz:
- **Hipótese nula (H₀**): As médias dos dois grupos são iguais, ou seja, não há diferença significativa entre elas.
- **Hipótese alternativa (H₁)**: As médias dos dois grupos são diferentes, ou seja, há uma diferença significativa entre elas.

- O teste calcula uma estatística chamada valor de **t** e um **p-valor**, que nos ajuda a decidir se devemos rejeitar a hipótese nula ou não.
  
  - Se **o p-valor** for menor que um certo nível de significância (geralmente 0.05 ou 5%), rejeitamos a hipótese nula e concluímos que as médias são significativamente diferentes.
  
  - Caso contrário, não há evidências suficientes para rejeitar a hipótese nula.

---

## Teste t - Média de matemática

```{r echo=TRUE, message=FALSE, warning=FALSE}

with(ecls, t.test(c5r2mtsc_std ~ catholic))

```

- **A diferença nas notas de matemática** entre alunos de escolas católicas (0,22) e não católicas (0,16) é pequena, e o teste t rejeita a hipótese de médias iguais apenas ao nível de significância de 10%, mas não ao de 5%.

- Isso sugere que a diferença **não é estatisticamente significativa** em um nível mais rigoroso, o que impede de afirmar com certeza que estudar em escola católica melhora o desempenho em matemática, já que a correlação pode ser casual mesmo considerando outros fatores.

---

## Teste t - Raça

```{r echo=TRUE, message=FALSE, warning=FALSE}

with(ecls, t.test(race_white ~ catholic)) # Raça branca

```

- A análise mostra que a proporção de alunos brancos é significativamente maior em escolas católicas (76,67%) do que em não católicas (65,37%), com um p-valor extremamente baixo que permite rejeitar a hipótese de não haver diferença.

- Assim, ser branco está estatisticamente associado a estudar em uma escola católica.

---

## Teste t - Idade da mãe

```{r echo=TRUE, message=FALSE, warning=FALSE}

with(ecls, t.test(p5hmage ~ catholic)) # Idade da mae

```

- A análise revela que a idade média das mães de alunos em escolas católicas (39,78 anos) é significativamente maior do que a das mães de alunos de escolas não católicas (37,79 anos), com um p-valor extremamente baixo (2.2e-16).

- Isso permite rejeitar a hipótese de que não há diferença, concluindo que as mães de alunos em escolas católicas são, em média, mais velhas de forma estatisticamente significativa.

---

## Teste t - Renda familiar (em milhares)

```{r echo=TRUE, message=FALSE, warning=FALSE}

with(ecls, t.test(w3income_1k ~ catholic)) # Renda familiar

```

- A análise mostra que a renda familiar média dos alunos em escolas católicas (86.180,63) é significativamente maior que a dos alunos em escolas não católicas (65.393,93). Com uma estatística t de -13,24, o teste t indica que essa diferença é estatisticamente significativa, tornando improvável que seja devida ao acaso.

- Assim, frequentar uma escola católica está associado a uma renda familiar significativamente mais alta.

---

## Teste t - Quantidade de lugares em que alunos moraram

```{r echo=TRUE, message=FALSE, warning=FALSE}

with(ecls, t.test(p5numpla ~ catholic)) # Quantidade de lugares em que alunos moraram

```

- A análise mostra que os alunos de escolas não católicas viveram, em média, em mais lugares (1,11) do que os alunos de escolas católicas (1,07). Com uma estatística t de 3,13, essa diferença é estatisticamente significativa, sugerindo que os alunos de escolas católicas tendem a ter vivido em menos lugares.

- Portanto, há uma diferença significativa no número de lugares onde os alunos viveram, com os de escolas não católicas tendo maior mobilidade.

---

## Teste t - Escolaridade da mãe até ensino médio (w3momed_hsb)

```{r echo=TRUE, message=FALSE, warning=FALSE}

with(ecls, t.test(w3momed_hsb ~ catholic)) # Escolaridade da mae

```

- A análise mostra que a proporção de mães com escolaridade até o ensino médio é maior entre alunos de escolas não católicas (39,23%) em comparação com escolas católicas (20,54%). Com uma estatística t de 12,36, a diferença é estatisticamente significativa, sugerindo que não é devida ao acaso.

- Portanto, a escolaridade das mães de alunos de escolas católicas é significativamente mais alta, indicando uma menor proporção de mães com escolaridade até o ensino médio nesse grupo.

---

## O que isso significa? 

Significa que simplesmente comparar a média de notas de alunos de escolas católicas com alunos de escolas não católicas não é uma abordagem adequada, pois **o contexto e o background desses alunos são diferentes**.

Para abordar essa questão, utilizaremos a estimativa de *propensity score*. Essa técnica nos permitirá criar um contrafactual, buscando entre todos os alunos que não frequentam escolas católicas aqueles que mais se assemelham ao perfil dos alunos de escolas católicas.

Dessa forma, poderemos realizar comparações mais justas e precisas.

---

## Estimativa do Propensity Score

Na prática, o processo de Propensity Score Matching geralmente envolve os seguintes passos:

--

**Modelagem do Propensity Score**: Utilizar regressão logística ou outro modelo para calcular a probabilidade de receber o tratamento com base em variáveis observáveis. 

--

**Matching**: Parear indivíduos tratados e não tratados com base em seus propensity scores, utilizando métodos como matching por pares, matching com reposição ou matching mais próximo.

--

**Análise de Resultados**: Comparar os resultados entre os grupos pareados para avaliar o efeito do tratamento.

--

Para que o matching forneça uma estimativa causal confiável, é necessário incluir covariáveis que estejam relacionadas tanto à variável de tratamento quanto aos resultados potenciais.

---

## Estimativa do Propensity Score - Regressão logística

Queremos calcular um propensity score individual que nos forneça a probabilidade de um aluno ser ou não de escola católica, levando em consideração variáveis como raça, renda, idade da mãe e o número de lugares onde a pessoa morou.

```{r echo=TRUE, message=FALSE, warning=FALSE} 

m_ps <- glm(catholic ~ race_white + w3income_1k + p5hmage + p5numpla + w3momed_hsb,
            family = binomial(), 
            data=ecls) # modelo de regressão logística

kable(summary(m_ps)$coefficients) # tabela com os coeficientes do modelo

```

---

## Modelagem do Propensity Score - Regressão logística

- A raça do aluno (`race_white`) é significativa, sugerindo que alunos brancos têm uma maior probabilidade de estar em escolas católicas.

- A renda familiar (`w3income_1k`) também se mostrou altamente significativa, indicando que quanto maior a renda da família, maior a probabilidade de o aluno estar em uma escola católica.

- A idade da mãe (`p5hmage`) também influencia positivamente essa probabilidade.

- Por outro lado, o número de lugares onde o aluno viveu (`p5numpla`) não apresentou significância estatística ao nível de 5%, mas tem um impacto negativo marginal.

- Finalmente, o nível educacional da mãe (`w3momed_hsb`) mostrou-se significativo, revelando que filhos de mães com ensino médio ou menos têm menor chance de frequentar escolas católicas, comparados a filhos de mães com nível superior.

---

## Visualização dos Propensity Scores

A área de comum suporte é o intervalo de *propensity* scores onde há sobreposição entre os grupos de tratamento e controle. Indivíduos fora dessa área são excluídos da análise, pois não possuem comparações adequadas, garantindo comparações válidas e uma melhor estimativa do efeito do tratamento.

```{r echo=FALSE, fig.align='center', fig.height=5, fig.width=15, message=FALSE, warning=FALSE}

ecls$pr_score<-predict(m_ps,type = "response") 
 

# Criar o gráfico com sobreposição de histogramas e eixo x ajustado
ggplot(ecls, aes(x = pr_score, fill = factor(catholic))) + 
  geom_histogram(alpha = 0.6, position = 'identity', bins = 20, color = "black") + 
  scale_fill_manual(values = c("gray", "orange"), 
                    labels = c("Não Católica", "Católica")) + 
  labs(title = "", 
       x = "Probabilidade de estudar em escola católica", 
       y = "", 
       fill = "Escola em que cursou ensino médio") + 
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +  # Ajuste do eixo x de 0,1 em 0,1
  theme_minimal() +
  theme(
    legend.position = "top", # Coloca a legenda no topo para melhor visualização
    text = element_text(size = 16), # Aumenta o tamanho geral do texto
    axis.text = element_text(size = 14), # Aumenta o tamanho dos textos dos eixos
    axis.title = element_text(size = 16), # Aumenta o tamanho dos títulos dos eixos
    legend.title = element_text(size = 16), # Aumenta o tamanho do título da legenda
    legend.text = element_text(size = 14)  # Aumenta o tamanho do texto da legenda
  )+
  theme(legend.position = "top") # Coloca a legenda no topo para melhor visualização



```

---

## Aplicação do Matching

O objetivo do matching é equilibrar as características entre os dois grupos para tornar a comparação mais justa, como em um experimento randomizado.

No contexto de PSM, ele calcula as probabilidades de um indivíduo receber um tratamento com base em variáveis de confusão (ou covariáveis) e depois emparelha indivíduos com scores de propensão semelhantes nos grupos de tratamento e controle.

```{r echo=TRUE, message=FALSE, warning=FALSE}

mod_match <- matchit(catholic ~ race_white +
                       w3income_1k +
                       p5hmage +
                       p5numpla +
                       w3momed_hsb,
                       method = "nearest",
                       data=ecls)

dta_m <- match.data(mod_match) # Nova base criada a partir do matching

```

---

## Aplicação do Matching

### Base após matching

Inicialmente, havia 930 indivíduos tratados e 4.499 no controle. Após o pareamento, todos os 930 tratados foram pareados com 930 controles, resultando em 3.569 controles que não tinham contrapartida no grupo de tratamento e foram descartados

```{r echo=FALSE, message=FALSE, warning=FALSE}

resumo_mod_match <- summary(mod_match)

kable(resumo_mod_match$nn)

```

---

## Aplicação do Matching

### Balanceamento das Covariáveis

Após o pareamento, as **diferenças** entre os grupos de tratamento e controle foram **drasticamente reduzidas**, o que poderia enviesar a estimativa do efeito do tratamento se essas diferenças não fossem ajustadas.

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}

dta_m %>%
group_by(catholic) %>%
select(one_of(ecls_cov)) %>%
summarise_all(funs(mean)) %>%
kable()

```

---

## Análise de Resultados

- No início, ao realizar o teste t comparando as variáveis, todas apresentaram p-valor menor que 0,05.

- Após o pareamento, no entanto, não rejeitamos a hipótese nula, o que significa que, em relação a essas variáveis, o grupo de controle e o de tratamento são estatisticamente iguais.

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Executando os testes t para cada variável
teste_raca_branca <- with(dta_m, t.test(race_white ~ catholic))  # Raça branca
teste_idade_mae <- with(dta_m, t.test(p5hmage ~ catholic))       # Idade da mãe
teste_renda <- with(dta_m, t.test(w3income_1k ~ catholic))       # Renda familiar
teste_num_lugares <- with(dta_m, t.test(p5numpla ~ catholic))    # Quantidade de lugares em que alunos moraram
teste_escolaridade_mae <- with(dta_m, t.test(w3momed_hsb ~ catholic))  # Escolaridade da mãe

# Criando um dataframe com o nome da variável, as médias de cada grupo, p-valor, estatística t e graus de liberdade
resultados <- data.frame(
  variavel = c("race_white", # Raça branca
               "p5hmage", # Idade da mãe
               "Renda familiar", 
               "Quantidade de lugares morados",
               "Escolaridade da mãe"),
  `Não católico` = c(teste_raca_branca$estimate[1],
                   teste_idade_mae$estimate[1],
                   teste_renda$estimate[1],
                   teste_num_lugares$estimate[1],
                   teste_escolaridade_mae$estimate[1]),
  `Católico` = c(teste_raca_branca$estimate[2],
                   teste_idade_mae$estimate[2],
                   teste_renda$estimate[2],
                   teste_num_lugares$estimate[2],
                   teste_escolaridade_mae$estimate[2]),
  p_value = c(teste_raca_branca$p.value,
              teste_idade_mae$p.value,
              teste_renda$p.value,
              teste_num_lugares$p.value,
              teste_escolaridade_mae$p.value),
  statistic = c(teste_raca_branca$statistic,
                teste_idade_mae$statistic,
                teste_renda$statistic,
                teste_num_lugares$statistic,
                teste_escolaridade_mae$statistic))

resultados %>%
kable()

```

---

## Análise de Resultados

Com os dados pareados, é simples calcular os efeitos do tratamento. Uma opção é usar o **teste t**.

```{r echo=TRUE, message=FALSE, warning=FALSE}

with(dta_m, t.test(c5r2mtsc_std ~ catholic))

```

- Os resultados mostram uma **diferença significativa** nas notas de matemática entre **alunos católicos e não católicos**, com um *p-valor* muito pequeno (0.000009417).

- Em média, os alunos não católicos têm notas significativamente maiores do que os alunos católicos.

---

## Análise de Resultados

Uma outra maneira de analisar é usar uma *regressão linear* da variável de interesse, que é a média de matemática, em relação ao tipo de escola:

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}

lm_treat1 <- lm(c5r2mtsc_std ~ catholic,data=dta_m)

# Extraindo o resumo do modelo
lm_treat1 <- summary(lm_treat1)

# Criando um dataframe com os coeficientes, erros padrão, t-values e p-values
summary_lm1 <- data.frame(
  Term = rownames(lm_treat1$coefficients),  # Nomes das variáveis
  Estimate = lm_treat1$coefficients[, "Estimate"],  # Estimativa dos coeficientes
  Std.Error = lm_treat1$coefficients[, "Std. Error"],  # Erro padrão
  t.value = lm_treat1$coefficients[, "t value"],  # Valores t
  p.value = lm_treat1$coefficients[, "Pr(>|t|)"]  # Valores p
)

# Exibindo o dataframe resultante
kable(summary_lm1, row.names = FALSE)

```

<br>

* Em média, ser aluno de uma escola católica está associado a uma redução de 0.18387 nas notas de matemática, em comparação com alunos de escolas não católicas.

* O sinal negativo mostra que, após ajustar para a variável, os alunos de escolas católicas tendem a ter desempenho inferior.

---

## Análise de Resultados

Para sofisticar um pouco mais o modelo, além de incluir apenas a variável católica, podemos controlar pelas demais variáveis para verificar se obtemos estimativas mais eficientes:

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}

lm_treat2 <- lm(c5r2mtsc_std ~ catholic + race_white + w3income_1k + p5hmage + p5numpla + w3momed_hsb,
                data=dta_m)

# Extraindo o resumo do modelo
lm_treat2 <- summary(lm_treat2)

# Criando um dataframe com os coeficientes, erros padrão, t-values e p-values
summary_lm2 <- data.frame(
  Term = rownames(lm_treat2$coefficients),  # Nomes das variáveis
  Estimate = lm_treat2$coefficients[, "Estimate"],  # Estimativa dos coeficientes
  Std.Error = lm_treat2$coefficients[, "Std. Error"],  # Erro padrão
  t.value = lm_treat2$coefficients[, "t value"],  # Valores t
  p.value = lm_treat2$coefficients[, "Pr(>|t|)"]  # Valores p
)

# Exibindo o dataframe resultante
kable(summary_lm2, row.names = FALSE)

```
 
<br> 
 
- **O resultado se mantém**: alunos de escolas católicas têm desempenho em matemática pior do que alunos de escolas não católicas quando usamos uma estrutura de pareamento.

---

## Análise de Resultados

Mesmo controlando todos os atributos de trajetórias que parecem relevantes, ainda assim **encontramos médias de desempenho em matemática diferentes**.

Esse resultado indica que **a escola tem uma diferença em relação aos alunos**; mesmo alunos com backgrounds iguais obtêm resultados diferentes.
 
---

## Conclusão

- A diferença que observamos ao analisar apenas as médias inicialmente leva a uma conclusão equivocada.

- Se comparássemos apenas as médias entre os tipos de escola, diríamos que as médias dos dois tipos de escolas são iguais para os alunos.

- No entanto, ao realizarmos o pareamento — uma técnica para dados observacionais que segue uma lógica quase experimental — e compararmos dois grupos muito semelhantes, o resultado se revela diferente.

- Na verdade, alunos de escolas não católicas que têm trajetórias de vida semelhantes às dos alunos de escolas católicas apresentam resultados melhores, em média, nas notas de matemática.

---

## Referências

**R Tutorial 8: Propensity Score Matching**: https://simonejdemyr.com/r-tutorials/statistics/tutorial8.html

**Avaliação de politícas públicas B**: https://www.youtube.com/watch?v=uMJeojTOcxc&ab_channel=CanaldaQuaest

**HW11a - The Lost Homework on PSM and LASSO**: https://rpubs.com/metricsdawg/1037525
